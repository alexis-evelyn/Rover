<div class="mdc-snackbar" id="no-reference-alert">
    <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
        <div class="mdc-snackbar__label" aria-atomic="false">
            No references were sent with this page. Checking the Wayback Machine directly!!!
        </div>
        <div class="mdc-snackbar__actions" aria-atomic="true">
            <button type="button" class="mdc-button mdc-snackbar__action">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Dismiss</span>
            </button>
        </div>
    </div>
</div>
<div class="mdc-snackbar" id="failed-lookup-alert">
    <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
        <div class="mdc-snackbar__label" aria-atomic="false">
            The Wayback Machine did not provide a reference to this tweet. Would you like to save this tweet?
        </div>
        <div class="mdc-snackbar__actions" aria-atomic="true">
            <button type="button" class="mdc-button mdc-snackbar__action" onclick="submitNewPage()">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Save Tweet</span>
            </button>
            <button type="button" class="mdc-button mdc-snackbar__action">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Dismiss</span>
            </button>
        </div>
    </div>
</div>
<script>
    // To Be Able To Work With Client Side Later If Desired
    tweet = {tweet_json};
    handle = "{twitter_handle}";

    // Snackbar Notifications
    const MDCSnackbar = mdc.snackbar.MDCSnackbar;

    // Stolen From: https://stackoverflow.com/a/39914235/6828099
    async function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function handleReferenceLink() {
        $(document).ready(function () {
            if (!hasExistingReference(tweet)) {
                const referencesAlert = new MDCSnackbar(document.querySelector('#no-reference-alert'));
                referencesAlert.timeoutMs = 10000 // 10 Seconds

                checkExistingPage(tweet.id, handle).then(result_url => {
                    if (typeof(result_url) === typeof("")) {
                        // Success, Load Page Instead
                        console.log("Opening Previously Submitted Archive URL: " + result_url)
                        window.open(result_url, '_blank')

                        referencesAlert.close()
                    } else {
                        // Looks Like Last Resort, Hope A Live Page Can Be Saved
                        console.log("No Previously Submitted Archive URL Found!!!")
                        sleep(400).then(run => {
                            // You would think some kind of alarm clock functionality would exist, but nope, it's this trickery
                            // I intentionally slow down the closing and opening of alerts so I can get a fancy animation going instead of the jarring instant open/close/open again
                            // This is important as someone could have shitty internet or be blocked by their ISP/Country and therefore I want some kind of checking message to display
                            // without waiting for the response back. I then allow the user to save the page on the Wayback Machine itself in hopes to make it available in the future
                            // (as well as being able to visit the snapshot now if the tweet was live at the time).
                            referencesAlert.close()
                        })

                        const failedLookupAlert = new MDCSnackbar(document.querySelector('#failed-lookup-alert'));
                        failedLookupAlert.timeoutMs = 10000 // 10 Seconds

                        sleep(500).then(run => {
                            failedLookupAlert.open()
                        })
                    }
                })

                referencesAlert.open()
            } else {
                window.open(tweet.reference, '_blank')
            }
        });
    }

    function hasExistingReference(tweet) {
        return !(!('reference' in tweet) || (tweet.reference === ""));
    }

    async function checkExistingPage(tweet_id, account_handle) {
        let api = "https://archive.org/wayback/available"
        let tweet_url = "twitter.com/" + account_handle + "/status/" + tweet_id
        console.debug("Checking If '" + tweet_url + "' Has Been Archived!!!")

        // For Dynamic GET Requests
        let parameters = {"url": tweet_url}

        let results = $.ajax({
            type: 'GET',
            url: api,
            data: parameters,
            dataType: "text", // Forces Ajax To Process As String
            cache: true, // Keep Browser From Caching Data
            async: true, // Already In Async Function
            error: function (response) {
                console.error("Could Not Retrieve Wayback Availability API Data For " + api + "?url=" + tweet_url + "!!!")
                // return false
            },
            success: function (response) {
            },
            complete: function (response) {
                console.debug('Response Code: ' + response.status)

                // Read JSON Here?
                // return (response.status === 200)
            }
        });

        return results.then(text => {
            try {
                let json = $.parseJSON(text);
                return "https://web.archive.org/web/" + json.archived_snapshots.closest.timestamp + "/" + tweet_url
            } catch (err) {
                console.warn("No Results Found From Wayback Availability API For " + api + "?url=" + tweet_url + "!!!")
                return null
            }
        })
    }

    async function submitNewPage() {
        let tweet_url = "https://twitter.com/" + handle + "/status/" + tweet.id
        let api = "https://web.archive.org/save/" + tweet_url

        window.open(api, '_blank')
    }

    function viewLiveTweet() {
        let tweet_url = "https://twitter.com/" + handle + "/status/" + tweet.id
        window.open(tweet_url, '_blank')
    }
</script>
<div class="cards" id="gov-tweets">
    <div class="mdc-card tweet-card">
        <div class="mdc-card__primary-action mdc-theme--text-primary-on-dark mdc-theme--primary-bg card__content" tabindex="0">
            <div>
                <h2 class="card__title mdc-typography mdc-typography--headline6">Tweet By {account_name} (@{twitter_handle})</h2>
            </div>
            <div class="card__text mdc-typography mdc-typography--body2">{tweet_text}</div>
        </div>
        <div class="mdc-card__actions mdc-theme--text-secondary-on-dark mdc-theme--secondary-bg card__actions">
            <div class="mdc-card__action-buttons">
                <button class="mdc-button download-button mdc-card__action mdc-card__action--button mdc-button--raised">  <span class="mdc-button__ripple"></span> {device}</button>
                <button class="mdc-button download-button mdc-card__action mdc-card__action--button mdc-button--raised" onclick="handleReferenceLink()">  <span class="mdc-button__ripple"></span> Open Reference</button>
                <button class="mdc-button download-button mdc-card__action mdc-card__action--button mdc-button--raised" onclick="viewLiveTweet()">  <span class="mdc-button__ripple"></span> Live Tweet</button>
            </div>
        </div>
    </div>
</div>
